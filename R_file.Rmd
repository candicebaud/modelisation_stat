---
title: "Séminaire de modélisation statistique"
author: "Candice Baptiste Raja"
date: "2023-04-07"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE)
```


```{r working directory and data, echo=FALSE, include=FALSE}
lapply(c("dplyr","chron","ggplot2","tidyr","questionr","survival","forcats","tidyselect",
         "data.table","table1","lubridate", "ggpubr","viridis","finalfit","survminer",
         "ggpubr", "ggthemes", "gridExtra", "rstatix","stringr",
         "wesanderson","kableExtra", "naniar","boot","scales","ggsci", "stringr",
         "Hmisc","DescTools","swimplot", 'stats', 'EnvStats', 'finalfit', 'data.table'), 
       library, character.only=TRUE)

#setwd("C:/Users/candi/Desktop/ETUDES/ENSAE2A/semestre 2/options/projet stat")

```

La base utilisée est disponible à ce lien :https://www.data.gouv.fr/fr/datasets/donnees-hospitalieres-relatives-a-lepidemie-de-covid-19/
et contient les taux d'incidence des hospitalisations, décès et réanimations. 


```{r tidy the data 2, echo=FALSE, include = FALSE}
data <- fread('covid-hospit-incid-2023-03-31-18h01 (1).csv', sep=";")

data <- data %>% mutate(
  jour = as.Date(jour , format = "%Y-%m-%d")
)
data <- data %>% mutate(
  dep = as.factor(dep)
)

data <- data %>% filter(dep != '971') %>% filter(dep !='972')%>% filter(dep !='973')%>% filter(dep !='974')%>% filter(dep !='976')%>% filter(dep !='978') #pour supprimer les domtom

```

# Taux d'incidence hospitalisation, de réanimation et de décès agrégés au niveau national
```{r, fig.align="center"}
library(cowplot)
data_agreg <- data %>% group_by(jour) %>%summarise(Taux_agrégé_hosp = sum(incid_hosp), Taux_agrege_rea = sum(incid_rea), Taux_agrege_dc = sum(incid_dc), Taux_agrege_rad = sum(incid_rad))

g1 <- data_agreg %>% ggplot(aes(x=jour, y=Taux_agrégé_hosp)) + geom_line() + xlab('Date') + ylab("Hospitalisations")
g2 <- data_agreg %>% ggplot(aes(x=jour, y=Taux_agrege_rea)) + geom_line() + xlab('Date') + ylab("Réanimations")
g3 <- data_agreg %>% ggplot(aes(x=jour, y=Taux_agrege_dc)) + geom_line() + xlab('Date') + ylab("Décès")
g4 <- data_agreg %>% ggplot(aes(x=jour, y=Taux_agrege_rad)) + geom_line()+ xlab('Date') + ylab("Retours à domicile")

plot_grid(g1, g2, g3, g4)
```

```{r, fig.align="center"}
data_agreg <- data_agreg %>% mutate(
  monday = case_when(
    weekdays(jour) == 'lundi' ~ 1,
    TRUE ~ 0
  ),
  num_monday = case_when(
    monday == 1~ cumsum(monday),
    TRUE ~ 0),
  tuesday = case_when(
    weekdays(jour) == 'mardi' ~ 1,
    TRUE ~ 0
  ),
  num_tuesday = case_when(
    tuesday == 1~ cumsum(tuesday),
    TRUE ~ 0),
  wed = case_when(
    weekdays(jour) == 'mercredi' ~ 1,
    TRUE ~ 0
  ),
  num_wed = case_when(
    wed == 1~ cumsum(wed) ,
    TRUE ~ 0),
  thur = case_when(
    weekdays(jour) == 'jeudi' ~ 1,
    TRUE ~ 0
  ),
  num_thur = case_when(
    thur == 1~ cumsum(thur) - 1,
    TRUE ~ 0),
  fri = case_when(
    weekdays(jour) == 'vendredi' ~ 1,
    TRUE ~ 0
  ),
  num_fri = case_when(
    fri == 1~ cumsum(fri) - 1,
    TRUE ~ 0),
  sat = case_when(
    weekdays(jour) == 'samedi' ~ 1,
    TRUE ~ 0
  ),
  num_sat = case_when(
    sat == 1~ cumsum(sat) - 1,
    TRUE ~ 0),
  sun = case_when(
    weekdays(jour) == 'dimanche' ~ 1,
    TRUE ~ 0
  ),
  num_sun = case_when(
    sun == 1~ cumsum(sun) - 1,
    TRUE ~ 0),
  week = num_monday + num_tuesday + num_wed + num_thur + num_fri + num_sat + num_sun
)



``` 

# Moyenne par semaine

```{r, fig.align="center"}
#la série par semaine
#données normales sur 7 jours 
g1 <- data_agreg %>% group_by(week) %>% summarise(s=mean(Taux_agrégé_hosp))%>%ggplot(aes(x=week,y=s))+
  geom_line() + xlab('Semaine') + ylab('Hospitalisations')

g2 <- data_agreg %>% group_by(week) %>% summarise(s=mean(Taux_agrege_rea))%>%ggplot(aes(x=week,y=s))+
  geom_line() + xlab('Semaine') + ylab('Réanimations')

g3 <- data_agreg %>% group_by(week) %>% summarise(s=mean(Taux_agrege_dc))%>%ggplot(aes(x=week,y=s))+
  geom_line() + xlab('Semaine') + ylab('Décès')

g4 <- data_agreg %>% group_by(week) %>% summarise(s=mean(Taux_agrege_rad))%>%ggplot(aes(x=week,y=s))+
  geom_line() + xlab('Semaine') + ylab('Retours à domicile')

plot_grid(g1,g2,g3,g4)


``` 


# Dérivée log
En utilisant la différence première sur les valeurs agrégrées par semaine, on a des graphes cohérents avec l'article. 
Pour éviter d'avoir le dernier pic qui écrase le reste, on enlève les valeurs des deux dernières semaines.
```{r, fig.align="center"}
data_week <- data_agreg %>% group_by(week) %>% summarise(s_hosp=mean(Taux_agrégé_hosp), s_rea = mean(Taux_agrege_rea), s_dc = mean(Taux_agrege_dc), s_rad = sum(Taux_agrege_rad))

g5 <- data_week %>% mutate(
  diff_hosp = diff(s_hosp)/s_hosp
) %>% filter(week<158) %>% ggplot(aes(x=week,y=diff_hosp))+
  geom_line() + xlab('jour') + ylab('Hospitalisations (Série différenciée)')


g6 <- data_week %>% mutate(
  diff_rea = diff(s_rea)/s_rea
) %>% filter(week<158) %>% ggplot(aes(x=week,y=diff_rea))+
  geom_line() + xlab('jour') + ylab('Réanimations (série différenciée)')

#g7 <- data_week %>% mutate(diff_dc = diff(s_dc)/s_dc)  %>% filter(week<158)%>% ggplot(aes(x=week,y=diff_dc))+ geom_line() + xlab('jour') + ylab('Décès')

#g8 <- data_week %>% mutate(diff_rad = diff(s_rad)/s_rad) %>% filter(week<158) %>% ggplot(aes(x=week,y=diff_rad))+geom_line() + xlab('jour') + ylab('RAD')


plot_grid(g1, g2, g5, g6)
```

# Moyenne mobile 
```{r, fig.align="center"}
#test <- data_agreg %>% mutate(diff_hosp = diff(Taux_agrégé_hosp)/Taux_agrégé_hosp, diff_rea = diff(Taux_agrege_rea)/Taux_agrege_rea, diff_dc = diff(Taux_agrege_dc)/Taux_agrege_dc, diff_rad = diff(Taux_agrege_rad)/Taux_agrege_rad) 

library('zoo')
m2 <- rollmean(data_agreg$Taux_agrégé_hosp, k=7, align = 'right', fill = NA)
m_hosp_diff <- diff(m2)/m2
#plot(data_agreg$jour, m2, type = 'l', col = 'gray')

m1 <- rollmean(data_agreg$Taux_agrege_rea, k=7, align = 'right', fill = NA)
m_rea_diff <- diff(m1)/m1

data_agreg <- data_agreg %>% mutate(
  m_hosp_diff = m_hosp_diff,
  m_rea_diff = m_rea_diff
)


g7 <- ggplot(data_agreg, aes(jour, m_hosp_diff)) + geom_line() + ylab('Hospitalisations (différenciée)')

g8 <- ggplot(data_agreg, aes(jour, m_rea_diff)) + geom_line() + ylab('Réanimations (différenciée)')

plot_grid(g1, g2, g7, g8)
```

# En filtrant pour ne pas avoir le gros pic qui écrase tout et en mettant tout en moyenne mobile
```{r, fig.align="center"}
#test <- data_agreg %>% mutate(diff_hosp = diff(Taux_agrégé_hosp)/Taux_agrégé_hosp, diff_rea = diff(Taux_agrege_rea)/Taux_agrege_rea, diff_dc = diff(Taux_agrege_dc)/Taux_agrege_dc, diff_rad = diff(Taux_agrege_rad)/Taux_agrege_rad) 

library('zoo')

data_agreg <- data_agreg %>% mutate(
  m_hosp = rollmean(Taux_agrégé_hosp, k=7, align = 'right', fill = NA),
  m_rea = rollmean(Taux_agrege_rea, k=7, align = 'right', fill = NA)
)

#g1_bis <- data_agreg %>% filter(week<140) %>% group_by(week) %>% summarise(s=mean(Taux_agrégé_hosp))%>%ggplot(aes(x=week,y=s))+geom_line() + xlab('Semaine') + ylab('Hospitalisations')

g1_bis_bis <- data_agreg %>%filter(jour > as.Date('2022-01-01', format = '%Y-%m-%d')) %>% filter(jour <as.Date('2022-06-01', format = '%Y-%m-%d'))%>% ggplot(aes(x=jour, y = m_hosp)) + geom_line() + ylab('Hospitalisations')

#g2_bis <- data_agreg %>%  filter(week<140) %>%group_by(week) %>% summarise(s=mean(Taux_agrege_rea))%>%ggplot(aes(x=week,y=s))+geom_line() + xlab('Semaine') + ylab('Réanimations')

g2_bis_bis <- data_agreg %>%filter(jour > as.Date('2022-01-01', format = '%Y-%m-%d')) %>% filter(jour <as.Date('2022-06-01', format = '%Y-%m-%d')) %>% ggplot(aes(x=jour, y = m_rea)) + geom_line() + ylab('Réanimations')

g9 <- data_agreg%>%filter(jour > as.Date('2022-01-01', format = '%Y-%m-%d')) %>% filter(jour <as.Date('2022-06-01', format = '%Y-%m-%d'))%>%ggplot(aes(jour, m_hosp_diff)) + geom_line() + ylab('Hospitalisations (différenciée)')

g10 <-  data_agreg %>%filter(jour > as.Date('2022-01-01', format = '%Y-%m-%d')) %>% filter(jour <as.Date('2022-06-01', format = '%Y-%m-%d')) %>%ggplot(aes(jour, m_rea_diff)) + geom_line() + ylab('Réanimations (différenciée)')

plot_grid(g1_bis_bis, g2_bis_bis, g9, g10)
```

# Points de rupture
```{r, fig.align="center"}
data_agreg <- data_agreg %>% mutate(
  intercept = 1
)

data_agreg <- data_agreg %>% mutate(
  temps = cumsum(intercept)
)

corresp <- function(liste_dates){
  pts_rupture <- rep(NA, length(liste_dates))
  for(i in 1:length(liste_dates)){
    pts_rupture[i] = (data_agreg %>% filter(jour == as.Date(liste_dates[i], format = '%Y-%m-%d')))$temps
  }
  return(pts_rupture)
}

creer_base <- function(pts_rupture){
  pts_rupture = sort(pts_rupture, decreasing = F)
  mat <- matrix(nrow = length(data_agreg$temps), ncol = length(pts_rupture))
  for (j in 1:length(pts_rupture)){
    mat[,j] = c(rep(0, pts_rupture[j]), seq(from = 1, to = length(data_agreg$temps) - pts_rupture[j], by = 1))
  }
  return(mat)
}

ajout_base <- function(pts_rupture, data_agreg){
  mat = as.data.frame(creer_base(pts_rupture))
  return(cbind(data_agreg, mat))
}

liste_dates <- c('2020-04-19', '2020-05-01')
pts_rupture <- corresp(liste_dates)
new_data <- ajout_base(pts_rupture, data_agreg)

reg <- lm(log(Taux_agrégé_hosp) ~ temps + I(temps^2) + V1 + V2, data = new_data)
summary(reg)

coef = reg$coef

fonction_obtenue <- function(pts_rupture, coef, x){
  sum = sum(coef[4:length(coef)]*(x-pts_rupture)**2)
  return(exp(coef[1] + coef[2]*x + coef[3]*x**2 + sum))
}
x = seq(from = 1, to = 100, by = 1)
to_plot = fonction_obtenue(pts_rupture, coef, x)

plot(x, to_plot)

new_data %>% filter(jour == as.Date('2022-06-01', format = '%Y-%m-%d'))

coef
``` 